# Railway Deployment Guide

This guide will help you deploy the UIBRAS face recognition attendance system to Railway.

## Prerequisites

1. A Railway account (sign up at [railway.app](https://railway.app))
2. Your code pushed to a Git repository (GitHub, GitLab, or Bitbucket)
3. Railway CLI (optional, for local testing)

## Quick Deploy Steps

### 1. Connect Your Repository

1. Log in to [Railway Dashboard](https://railway.app/dashboard)
2. Click "New Project"
3. Select "Deploy from GitHub repo" (or your Git provider)
4. Select your repository and branch

### 2. Configure Environment Variables

In your Railway project settings, add these environment variables:

- `FLASK_DEBUG`: Set to `false` for production (or omit for default)
- `DATABASE_URL`: Railway will automatically provide this if you add a PostgreSQL service

### 3. Add PostgreSQL Database (Recommended)

**Important**: SQLite files are ephemeral on Railway and will be lost on each deployment. Use PostgreSQL for production.

**ðŸ“– Detailed Instructions**: See [ADD_POSTGRES_DB.md](./ADD_POSTGRES_DB.md) for step-by-step guide with screenshots and troubleshooting.

Quick steps:

1. In your Railway project, click "New" â†’ "Database" â†’ "Add PostgreSQL"
2. Railway will automatically set the `DATABASE_URL` environment variable
3. The app is configured to automatically convert `postgres://` to `postgresql://` for SQLAlchemy compatibility
4. Your app will automatically use the database - no additional configuration needed!

### 4. Deploy

Railway will automatically:

- Detect Python from `runtime.txt`
- Install dependencies from `requirements.txt`
- Run the `web` process from `Procfile`

## Configuration Files

The following files are configured for Railway deployment:

- **`Procfile`**: Defines the web process using Gunicorn
- **`requirements.txt`**: Python dependencies
- **`runtime.txt`**: Python version (3.9.18)
- **`railway.json`**: Railway-specific configuration (optional)
- **`.gitignore`**: Excludes virtualenv, database files, and generated images

## Environment Variables

| Variable       | Description                                | Required             | Default                         |
| -------------- | ------------------------------------------ | -------------------- | ------------------------------- |
| `PORT`         | Server port (set automatically by Railway) | No                   | 5000                            |
| `DATABASE_URL` | PostgreSQL connection string               | Yes (for production) | `sqlite:///face_recognition.db` |
| `FLASK_DEBUG`  | Enable Flask debug mode                    | No                   | `false`                         |

## Build Configuration

- **Builder**: NIXPACKS (auto-detected)
- **Start Command**: `gunicorn app:app --bind 0.0.0.0:${PORT:-5000} --workers 2 --threads 2 --timeout 120`
- **Python Version**: 3.9.18 (specified in `runtime.txt`)

## Important Notes

### Database

- **SQLite**: Works for development but data is ephemeral on Railway
- **PostgreSQL**: Required for production (recommended)
- The app automatically handles Railway's `postgres://` URL format

### File Storage

- Uploaded images (`captured_students_faces/` and `recognition_image/`) are stored on the filesystem
- These directories are ephemeral and will be lost on redeploy
- Consider using Railway Volumes or external storage (S3, Cloudinary) for production

### Resource Requirements

This application uses:

- TensorFlow and OpenCV (CPU-intensive)
- DeepFace for face recognition
- Consider upgrading Railway plan if you experience timeouts or memory issues

### Timeout Settings

- Gunicorn timeout: 120 seconds (configured in Procfile)
- Railway default timeout: 60 seconds (may need to increase in Railway settings)

## Troubleshooting

### Build Fails

- Check that all dependencies in `requirements.txt` are valid
- Verify Python version in `runtime.txt` is supported
- Check Railway build logs for specific errors

### App Crashes on Startup

- Verify `DATABASE_URL` is set correctly
- Check that PostgreSQL service is running (if using)
- Review Railway logs for error messages

### Face Recognition Not Working

- Ensure model files are included in the repository or downloaded at runtime
- Check that `captured_students_faces/` directory has proper permissions
- Verify DeepFace models are accessible

### OpenCV Import Error (libGL.so.1)

If you see `ImportError: libGL.so.1: cannot open shared object file`:

- **Solution**: The project uses `opencv-python-headless` instead of `opencv-python` to avoid GUI library dependencies
- This is already configured in `requirements.txt`
- If you see this error, ensure you're using `opencv-python-headless>=4.5.5.64` in requirements.txt
- The headless version works perfectly for server-side image processing (no GUI needed)

### Database Connection Issues

- Verify `DATABASE_URL` format (should start with `postgresql://`)
- Check PostgreSQL service is running
- Ensure database credentials are correct

## Local Testing

Test the production setup locally:

```bash
# Install dependencies
pip install -r requirements.txt

# Set environment variables
export PORT=8000
export DATABASE_URL=postgresql://user:pass@localhost/dbname  # or use SQLite
export FLASK_DEBUG=false

# Run with Gunicorn (production-like)
gunicorn app:app --bind 0.0.0.0:8000 --workers 2 --threads 2 --timeout 120
```

## Monitoring

- View logs in Railway Dashboard â†’ Your Service â†’ Logs
- Monitor resource usage in Railway Dashboard â†’ Metrics
- Set up alerts for crashes or high resource usage

## Next Steps

1. **Set up custom domain** (Railway Dashboard â†’ Settings â†’ Domains)
2. **Configure SSL/TLS** (automatic with Railway)
3. **Set up monitoring** and alerts
4. **Consider using Railway Volumes** for persistent file storage
5. **Implement backup strategy** for database

## Support

- Railway Documentation: https://docs.railway.app
- Railway Discord: https://discord.gg/railway
- Project Issues: Check your repository's issue tracker
